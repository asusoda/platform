name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        port: ${{ secrets.VPS_SSH_PORT }}
        password: ${{ secrets.VPS_SSH_PASSWORD }}
        script: |
          set -e  # Exit on any error
          
          # Configuration
          PROJECT_DIR="${PROJECT_DIR:-/var/www/soda-internal-api}"
          
          # Check if project directory exists
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "Error: Project directory $PROJECT_DIR not found"
            exit 1
          fi
          
          cd "$PROJECT_DIR"
          
          # Discard any local changes to prevent merge conflicts
          echo "Discarding local changes..."
          make discard-local-changes || {
            echo "Failed to discard local changes!"
            exit 1
          }
          
          # Run deployment using make
          echo "Starting deployment..."
          make deploy || {
            echo "Deployment failed!"
            make logs
            exit 1
          }
          
          # Verify deployment health
          echo "Verifying deployment health..."
          make health || {
            echo "Health check failed!"
            make status
            exit 1
          }
          
          echo "âœ… Deployment completed successfully!"
