
<!-- templates/editor.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrapesJS Editor</title>
    <!-- GrapesJS and dependencies -->
    <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://unpkg.com/grapesjs-preset-webpage"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Leckerli+One&display=swap" rel="stylesheet">

    <style>
        body, html {
            margin: 0;
            height: 100%;
        }

        @import url('https://fonts.googleapis.com/css2?family=Pacifico&display=swap');

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background-color: #4a4a4a; /* Dark grey toolbar background */
            border-bottom: 1px solid #1a1a1a;
            height: 48px;
        }

        .topbar-title {
            font-family: 'Leckerli One', cursive;
            font-size: 24px;
            color: #e865dd; /* Beautiful purple color */
            margin: 0;
        }

        .topbar-buttons {
            display: flex;
            gap: 8px;
        }

        .gjs-btn {
            background-color: #3a3f44; /* Dark grey button */
            border: 0px solid #555;
            color: #e865dd; 
            font-size: 14px;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .gjs-btn:hover {
            background-color: #555a60;
            color: #ff85c1;
        }
        #editor {
            height: calc(100% - 56px);
        }
        .status-message {
            background: #27ae60;
            color: white;
            padding: 10px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .status-message.show {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div id="status-message" class="status-message">Message</div>
    
    <div class="topbar">
      <div class="topbar-title">GrapesJS Editor</div>
      <div class="topbar-buttons">
        <button id="view-btn" class="gjs-btn">View Page</button>
        <button id="save-btn" class="gjs-btn">Save Changes</button>
        <button id="save-html-btn" class="gjs-btn">Save as HTML</button>
        <button id="save-image-btn" class="gjs-btn">Save as Image</button>
        <button id="send-discord-btn" class="gjs-btn">Send to Discord</button>
        <button id="send-instagram-btn" class="gjs-btn">Send to Instagram</button>
        <button id="send-linkedin-btn" class="gjs-btn">Send to LinkedIn</button>

      </div>
    </div>
    
    <div id="editor"></div>
    
    <script>
        const editor = grapesjs.init({
            container: '#editor',
            height: '100%',
            width: 'auto',
            fromElement: false,
            storageManager: false,
            plugins: ['gjs-preset-webpage'],
            pluginsOpts: {
                'gjs-preset-webpage': {}
            }
        });

        // Show status message function
        function showStatusMessage(message, isError = false) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.style.backgroundColor = isError ? '#e74c3c' : '#27ae60';
            statusEl.classList.add('show');
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // Load content from the server
        fetch('/marketing/load-content')
            .then(response => response.json())
            .then(data => {
                // Set the editor content
                editor.setComponents(data.html);
                editor.setStyle(data.css);
            })
            .catch(error => {
                console.error('Error loading content:', error);
                showStatusMessage('Error loading content', true);
            });

        // Save button handler
        document.getElementById('save-btn').addEventListener('click', () => {
            const htmlContent = editor.getHtml();
            const cssContent = editor.getCss();
            
            fetch('/marketing/update-content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    html: htmlContent,
                    css: cssContent
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatusMessage('Content saved successfully!');
                } else {
                    showStatusMessage('Error saving content', true);
                }
            })
            .catch(error => {
                console.error('Error saving content:', error);
                showStatusMessage('Error saving content', true);
            });
        });

        // View button handler
        document.getElementById('view-btn').addEventListener('click', () => {
            window.open('/marketing/view', '_blank');
        });
        
        // Save as HTML button handler
        document.getElementById('save-html-btn').addEventListener('click', () => {
            const htmlContent = editor.getHtml();
            const cssContent = editor.getCss();

            const fullHtml = `
              <!DOCTYPE html>
              <html lang="en">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>Exported GrapesJS Page</title>
                  <style>
                      ${cssContent}
                  </style>
              </head>
              <body>
                  ${htmlContent}
              </body>
              </html>
              `;

            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'soda_banner_full.html';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Save as Image button handler
        document.getElementById('save-image-btn').addEventListener('click', () => {
          const iframe = document.querySelector('.gjs-frame');
          if (!iframe) {
              alert('GrapesJS iframe not found.');
              return;
          }

          const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

          // Try to select the banner block specifically if it exists
          let targetElement = iframeDocument.querySelector('.banner');
          if (!targetElement) {
              // Fallback to capture entire body if no .banner found
              targetElement = iframeDocument.body;
          }

          html2canvas(targetElement, {
              allowTaint: true,
              useCORS: true,
              backgroundColor: null
          }).then(canvas => {
              const link = document.createElement('a');
              link.download = 'soda_banner_only.png';
              link.href = canvas.toDataURL();
              link.click();
          }).catch(err => {
              console.error('Error capturing image:', err);
              alert('Failed to capture image.');
          });
      });

      // Send to Discord button handler
      document.getElementById('send-discord-btn').addEventListener('click', () => {
          const iframe = document.querySelector('.gjs-frame');
          if (!iframe) {
              alert('GrapesJS iframe not found.');
              return;
          }

          const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
          let targetElement = iframeDocument.querySelector('.banner');
          if (!targetElement) {
              targetElement = iframeDocument.body;
          }

          html2canvas(targetElement, {
              allowTaint: true,
              useCORS: true,
              backgroundColor: null
          }).then(canvas => {
              canvas.toBlob(blob => {
                  const formData = new FormData();
                  formData.append('file', blob, 'soda_banner.png');
                  formData.append('content', '@audience');

                  fetch('/marketing/post-to-discord', {
                      method: 'POST',
                      body: formData
                  }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          showStatusMessage('Image sent to Discord successfully!');
                      } else {
                          showStatusMessage('Failed to send image to Discord', true);
                      }
                  }).catch(err => {
                      console.error('Network error sending to Discord:', err);
                      showStatusMessage('Network error sending image to Discord', true);
                  });
              }, 'image/png');
          }).catch(err => {
              console.error('Error capturing image:', err);
              alert('Failed to capture image.');
          });
      });
        // Send to Instagram button handler
        document.getElementById('send-instagram-btn').addEventListener('click', () => {
        const iframe = document.querySelector('.gjs-frame');
        if (!iframe) {
            alert('GrapesJS iframe not found.');
            return;
        }

        const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
        let targetElement = iframeDocument.querySelector('.banner');
        if (!targetElement) {
            targetElement = iframeDocument.body;
        }

        html2canvas(targetElement, {
            allowTaint: true,
            useCORS: true,
            backgroundColor: null
        }).then(canvas => {
            canvas.toBlob(blob => {
                // Prompt for a caption
                const caption = prompt('Enter Instagram caption:', 'Check out our upcoming SoDA event!');
                if (!caption) return; // User cancelled
                
                const formData = new FormData();
                formData.append('file', blob, 'soda_banner.png');
                formData.append('caption', caption);

                fetch('/marketing/post-to-instagram', {
                    method: 'POST',
                    body: formData
                }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatusMessage('Image sent to Instagram successfully!');
                    } else {
                        showStatusMessage('Failed to send image to Instagram: ' + data.message, true);
                    }
                }).catch(err => {
                    console.error('Network error sending to Instagram:', err);
                    showStatusMessage('Network error sending image to Instagram', true);
                });
            }, 'image/png');
        }).catch(err => {
            console.error('Error capturing image:', err);
            alert('Failed to capture image.');
        });
    });
    
    // Send to LinkedIn button handler
    document.getElementById('send-linkedin-btn').addEventListener('click', () => {
        const iframe = document.querySelector('.gjs-frame');
        if (!iframe) {
            alert('GrapesJS iframe not found.');
            return;
        }

        const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
        let targetElement = iframeDocument.querySelector('.banner');
        if (!targetElement) {
            targetElement = iframeDocument.body;
        }

        html2canvas(targetElement, {
            allowTaint: true,
            useCORS: true,
            backgroundColor: null
        }).then(canvas => {
            canvas.toBlob(blob => {
                // Prompt for LinkedIn content
                const content = prompt('Enter LinkedIn post content:', 'Excited to announce our upcoming SoDA event!');
                if (!content) return; // User cancelled
                
                const formData = new FormData();
                formData.append('file', blob, 'soda_banner.png');
                formData.append('content', content);

                fetch('/marketing/post-to-linkedin', {
                    method: 'POST',
                    body: formData
                }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatusMessage('Content sent to LinkedIn successfully!');
                    } else {
                        showStatusMessage('Failed to send content to LinkedIn: ' + data.message, true);
                    }
                }).catch(err => {
                    console.error('Network error sending to LinkedIn:', err);
                    showStatusMessage('Network error sending content to LinkedIn', true);
                });
            }, 'image/png');
        }).catch(err => {
            console.error('Error capturing image:', err);
            alert('Failed to capture image.');
        });
    });

    </script>
</body>
</html>